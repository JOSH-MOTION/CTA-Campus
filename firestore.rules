
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isStaff() {
      // Check if the requesting user has the role of 'teacher' or 'admin'.
      // It looks up the user document of the person MAKING the request.
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['teacher', 'admin'];
    }

    // User profiles
    match /users/{userId} {
      // Any authenticated user can read any user's profile (for directory, etc.)
      allow read: if request.auth != null;
      
      // Students can only update specific, non-critical fields on their own profile.
      // They are explicitly forbidden from changing their role or totalPoints.
      allow update: if request.auth.uid == userId
                    && !('role' in request.resource.data)
                    && !('totalPoints' in request.resource.data);

      // Staff can update any field on any user's profile.
      allow update: if isStaff();
      
      // Points subcollection
      match /points/{pointId} {
        // Only staff can write to a user's points subcollection.
        // This is done via the awardPointsFlow, which is a secure server process.
        allow read, write: if isStaff();
      }
    }

    // Submissions
    match /submissions/{submissionId} {
      // Any authenticated user can create a submission record for their work.
      allow create: if request.auth != null;
      // Only staff can read or delete submissions.
      allow read, delete: if isStaff();
    }
    
    // Rules for collections managed primarily by staff
    match /{collection}/{docId}
    where collection in ['announcements', 'assignments', 'exercises', 'projects', 'resources', 'materials'] {
      // Any authenticated user can read these items.
      allow read: if request.auth != null;
      // Only staff can create, update, or delete these items.
      allow write: if isStaff();
    }
    
    // Roadmap Status - only staff can update completion for a generation.
    match /roadmap_status/{weekId} {
        allow read: if request.auth != null;
        allow write: if isStaff();
    }

    // Chat messages can be read/written by any authenticated user in that chat.
    match /chats/{chatId}/{message=**} {
        allow read, write: if request.auth != null;
    }

    // Notifications are private to the user they are assigned to.
    match /notifications/{notificationId} {
        allow read, write: if request.auth.uid == resource.data.userId;
    }
  }
}
